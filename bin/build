#!/bin/bash

set -e

PLATFORM=${1:-sdl3}
ARCH=${2:-64}

usage() {
    echo "Usage: $0 [sdl3|sdl3-local] [32|64]"
    echo "  sdl3:        Build with SDL3 (system/pkg-config)"
    echo "  sdl3-local:  Build with local SDL3 from external/"
    echo "  32:          Build 32-bit binary"
    echo "  64:          Build 64-bit binary (default)"
    exit 1
}

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    usage
fi

if [[ "$PLATFORM" != "sdl3" && "$PLATFORM" != "sdl3-local" ]]; then
    echo "Error: Invalid platform '$PLATFORM'"
    usage
fi

if [[ "$ARCH" != "32" && "$ARCH" != "64" ]]; then
    echo "Error: Invalid architecture '$ARCH'"
    usage
fi

echo "Building for platform: $PLATFORM (${ARCH}-bit)"

mkdir -p ./target
pushd ./target/

COMMON_FLAGS="-DHANDMADE_PRINTDEBUG=0 -DHANDMADE_SLOW=1 -DHANDMADE_INTERNAL=1 -g -Wall -Wno-unused-variable -Wno-write-strings -Werror -fno-rtti -fno-exceptions"

# Set architecture-specific flags
if [[ "$ARCH" == "32" ]]; then
    ARCH_FLAGS="-m32"
    ARCH_SUFFIX=".x86"
    RPATH_DIR='$ORIGIN/x86'
else
    ARCH_FLAGS=""
    ARCH_SUFFIX=""
    RPATH_DIR='$ORIGIN/x86_64'
fi

case $PLATFORM in
    "sdl3")
        echo "Compiling SDL3 version (system)..."
        bear -- c++ $COMMON_FLAGS $ARCH_FLAGS ../code/sdl3_handmade.cpp -o handmade$ARCH_SUFFIX `pkg-config sdl3 --cflags --libs` -Wl,-rpath,"$RPATH_DIR"
        ;;
    "sdl3-local")
        echo "Compiling SDL3 version (local)..."
        SDL3_LOCAL="$(cd ../external/SDL/install && pwd)"
        if [ ! -d "$SDL3_LOCAL" ]; then
            echo "Error: Local SDL3 not found at $SDL3_LOCAL"
            echo "Run './bin/setup-sdl3' to build SDL3 locally"
            exit 1
        fi
        SDL3_CFLAGS="-I$SDL3_LOCAL/include"
        SDL3_LIBS="-L$SDL3_LOCAL/lib -lSDL3 -Wl,-rpath,$SDL3_LOCAL/lib"
        bear -- c++ $COMMON_FLAGS $ARCH_FLAGS ../code/sdl3_handmade.cpp -o handmade$ARCH_SUFFIX $SDL3_CFLAGS $SDL3_LIBS -Wl,-rpath,"$RPATH_DIR"
        ;;
esac

popd

echo "Build completed successfully!"
