#!/bin/bash

set -e

PLATFORM=${1:-sdl3}
ARCH=${2:-64}

usage() {
    echo "Usage: $0 [sdl3|sdl3-local] [32|64]"
    echo "  sdl3:        Build with SDL3 (system/pkg-config)"
    echo "  sdl3-local:  Build with local SDL3 from external/"
    echo "  32:          Build 32-bit binary"
    echo "  64:          Build 64-bit binary (default)"
    echo ""
    echo "Environment variables:"
    echo "  USE_BEAR=1          Generate compile_commands.json (slower build)"
    echo "  BUILD_PLATFORM=1    Recompile platform layer (needed for platform changes)"
    exit 1
}

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    usage
fi

if [[ "$PLATFORM" != "sdl3" && "$PLATFORM" != "sdl3-local" ]]; then
    echo "Error: Invalid platform '$PLATFORM'"
    usage
fi

if [[ "$ARCH" != "32" && "$ARCH" != "64" ]]; then
    echo "Error: Invalid architecture '$ARCH'"
    usage
fi

echo "Building for platform: $PLATFORM (${ARCH}-bit)"

# Set up compiler wrapper (bear only if requested)
if [ "$USE_BEAR" = "1" ]; then
    echo "Using bear to generate compile_commands.json"
    COMPILER="bear -- c++"
else
    COMPILER="c++"
fi

mkdir -p ./target
pushd ./target/

COMMON_FLAGS="-DHANDMADE_PRINTDEBUG=0 -DHANDMADE_SLOW=1 -DHANDMADE_INTERNAL=1 -DGAME_LIB_PATH=\"./target/handmade.so\" -g -Wall -Wno-unused-variable -Wno-write-strings -Werror -fno-rtti -fno-exceptions"

# Always compile the game code (fast)
echo "Compiling game code..."
$COMPILER $COMMON_FLAGS -fPIC -shared ../code/handmade.cpp -o handmade_temp.so
mv handmade_temp.so handmade.so

# Conditionally compile platform layer (slow) - only when explicitly requested
if [ "$BUILD_PLATFORM" = "1" ]; then
    case $PLATFORM in
        "sdl3")
            echo "Compiling SDL3 platform layer (system)..."
            $COMPILER $COMMON_FLAGS ../code/sdl3_handmade.cpp -o handmade `pkg-config sdl3 --cflags --libs` -Wl,-rpath -ldl
            ;;
        "sdl3-local")
            echo "Compiling SDL3 platform layer (local)..."
            SDL3_LOCAL="$(cd ../external/SDL/install && pwd)"
            if [ ! -d "$SDL3_LOCAL" ]; then
                echo "Error: Local SDL3 not found at $SDL3_LOCAL"
                echo "Run './bin/setup-sdl3' to build SDL3 locally"
                exit 1
            fi
            SDL3_CFLAGS="-I$SDL3_LOCAL/include"
            SDL3_LIBS="-L$SDL3_LOCAL/lib -lSDL3 -Wl,-rpath,$SDL3_LOCAL/lib"
            $COMPILER $COMMON_FLAGS ../code/sdl3_handmade.cpp -o handmade $SDL3_CFLAGS $SDL3_LIBS -Wl,-rpath
            ;;
    esac
else
    echo "Skipping platform layer (use BUILD_PLATFORM=1 to rebuild)"
    if [ ! -f handmade ]; then
        echo "Warning: handmade executable not found. Platform layer needs to be built at least once."
        echo "Run: BUILD_PLATFORM=1 ./bin/build"
        exit 1
    fi
fi

popd

echo "Build completed successfully!"
